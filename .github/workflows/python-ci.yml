name: Python CI (FastAPI)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Detect project dir and requirements path (root or subfolder)
      - name: Detect project layout
        id: detect
        run: |
          set -e
          echo "PWD=$(pwd)"
          ls -la || true

          if [ -f requirements.txt ]; then
            echo "REQ=requirements.txt" >> "$GITHUB_ENV"
            echo "APP_DIR=." >> "$GITHUB_ENV"
            echo "Found requirements.txt at repo root"
          elif [ -f FreelanceProjectTracker/requirements.txt ]; then
            echo "REQ=FreelanceProjectTracker/requirements.txt" >> "$GITHUB_ENV"
            echo "APP_DIR=FreelanceProjectTracker" >> "$GITHUB_ENV"
            echo "Found requirements.txt in FreelanceProjectTracker/"
            ls -la FreelanceProjectTracker || true
          else
            echo "ERROR: requirements.txt not found (root or FreelanceProjectTracker/)."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'FreelanceProjectTracker/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install -r "$REQ"

      # ---------- OPTIONAL QUALITY STEPS (auto-skip if tool not installed) ----------
      - name: Ruff (optional)
        run: |
          if command -v ruff >/dev/null 2>&1; then
            echo "Running ruff…"
            ruff check "$APP_DIR"
          else
            echo "Ruff not installed; skipping. (Add 'ruff' to $REQ to enable.)"
          fi

      - name: Black check (optional)
        run: |
          if command -v black >/dev/null 2>&1; then
            echo "Running black --check…"
            black --check "$APP_DIR"
          else
            echo "Black not installed; skipping. (Add 'black' to $REQ to enable.)"
          fi

      - name: Pytest (optional)
        env:
          PYTHONPATH: ${{ env.PYTHONPATH }}:${{ env.APP_DIR }}
        run: |
          if [ -d tests ] || [ -d "$APP_DIR/tests" ]; then
            if python -m pip show pytest >/dev/null 2>&1; then
              echo "Running pytest…"
              # Prefer project-local tests if present, else repo-level
              if [ -d "$APP_DIR/tests" ]; then
                pytest -q "$APP_DIR/tests"
              else
                pytest -q
              fi
            else
              echo "pytest not installed; skipping. (Add 'pytest' to $REQ to enable.)"
            fi
          else
            echo "No tests/ directory; skipping pytest."
          fi
      # ------------------------------------------------------------------------------

      # Helpful debug (kept last so it doesn’t spam logs unless needed)
      - name: Show layout (debug)
        if: always()
        run: |
          echo "APP_DIR=$APP_DIR"
          echo "REQ=$REQ"
          echo "Tree at repo root:"
          ls -la
          echo "Tree at APP_DIR:"
          ls -la "$APP_DIR" || true
